<!DOCTYPE html>
<html lang="cs">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Detail gener√°toru</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg bg-body-tertiary">
      <div class="container-fluid">
        <a class="navbar-brand" href="generators.html">Zpƒõt na seznam</a>
      </div>
    </nav>

    <div class="container mt-4">
      <h2>Detail gener√°toru</h2>
      <div id="generatorDetail" class="card mt-3">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0" id="generatorName">Naƒç√≠t√°n√≠...</h5>
            <div>
              <button
                id="editGenerator"
                class="btn btn-sm btn-outline-primary me-2"
              >
                ‚úèÔ∏è
              </button>
              <button
                id="deleteGenerator"
                class="btn btn-sm btn-outline-danger"
              >
                üóëÔ∏è
              </button>
            </div>
          </div>

          <ul class="list-group mb-3 mt-3">
            <li class="list-group-item">
              <strong>Maxim√°ln√≠ v√Ωkon:</strong> <span id="maxOutput">-</span> W
            </li>
            <li class="list-group-item">
              <strong>Aktu√°ln√≠ v√Ωkon:</strong>
              <span id="currentOutput">-</span>
            </li>
            <li class="list-group-item">
              <strong>Z√°tƒõ≈æ aktu√°lnƒõ:</strong> <span id="sessionLoad">-</span>
            </li>
            <li class="list-group-item">
              <strong>Stav:</strong> <span id="status">-</span>
            </li>
            <li class="list-group-item">
              <strong>Start:</strong> <span id="sessionStart">-</span>
            </li>
          </ul>

          <div class="mt-3">
            <button class="btn btn-secondary mb-2 d-none" id="showLoadInput">
              Zmƒõnit z√°tƒõ≈æ
            </button>
            <button id="turnOn" class="btn btn-success me-2 d-none">
              Zapnout
            </button>
            <button id="turnOff" class="btn btn-danger d-none">Vypnout</button>
          </div>

          <div class="mt-4">
            <div class="input-group d-none" id="loadInputGroup">
              <input
                type="number"
                id="newLoad"
                class="form-control"
                placeholder="Zadejte z√°tƒõ≈æ (0‚Äì100)"
                min="0"
                max="100"
              />
              <button class="btn btn-primary" id="updateLoad">Potvrdit</button>
            </div>
          </div>

          <div id="statusMessage" class="mt-3"></div>
        </div>
      </div>
    </div>

    <!-- MODAL PRO EDITACI GENER√ÅTORU -->
    <div
      class="modal fade"
      id="editGeneratorModal"
      tabindex="-1"
      aria-labelledby="editGeneratorModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="editGeneratorModalLabel">
              Upravit gener√°tor
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Zav≈ô√≠t"
            ></button>
          </div>
          <div class="modal-body">
            <form id="editGeneratorForm">
              <div class="mb-3">
                <label for="editName" class="form-label"
                  >N√°zev gener√°toru</label
                >
                <input
                  type="text"
                  class="form-control"
                  id="editName"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="editMaxOutput" class="form-label"
                  >Maxim√°ln√≠ v√Ωkon (W)</label
                >
                <input
                  type="number"
                  class="form-control"
                  id="editMaxOutput"
                  required
                  min="1"
                />
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Zru≈°it
            </button>
            <button
              type="button"
              class="btn btn-primary"
              id="saveGeneratorChanges"
            >
              Ulo≈æit zmƒõny
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      let generatorId = null;
      let generator = null;
      let generatorIsOn = false;

      document.addEventListener("DOMContentLoaded", () => {
        const data = localStorage.getItem("selectedGenerator");
        const container = document.getElementById("generatorDetail");

        const title = document.getElementById("generatorName");
        const maxOutput = document.getElementById("maxOutput");

        if (data) {
          generator = JSON.parse(data);
          generatorId = generator.id;
          title.textContent = `${generator.name} (ID: ${generator.id})`;
          maxOutput.textContent = generator.max_output;
          loadSession();
        } else {
          container.innerHTML = `
          <div class="card-body">
            <div class="alert alert-danger">Gener√°tor nebyl nalezen. Vra≈•te se na <a href="generators.html">seznam</a>.</div>
          </div>`;
        }

        //  Otev≈ôen√≠ mod√°lu
        document
          .getElementById("editGenerator")
          .addEventListener("click", () => {
            document.getElementById("editName").value = generator.name;
            document.getElementById("editMaxOutput").value =
              generator.max_output;
            const modal = new bootstrap.Modal(
              document.getElementById("editGeneratorModal")
            );
            modal.show();
          });

        //  Ulo≈æen√≠ zmƒõn
        document
          .getElementById("saveGeneratorChanges")
          .addEventListener("click", () => {
            const newName = document.getElementById("editName").value.trim();
            const newMax = document
              .getElementById("editMaxOutput")
              .value.trim();

            if (!newName || !newMax) {
              alert("Vypl≈àte v≈°echna pole.");
              return;
            }

            fetch("http://localhost:8000/api/generators/update", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                id: generatorId,
                name: newName,
                max_output: newMax,
                last_load_percentage: generator.last_load_percentage || "0",
              }),
            })
              .then((res) => res.json())
              .then((data) => {
                if (data.status === "success") {
                  // alert("Gener√°tor byl √∫spƒõ≈°nƒõ aktualizov√°n.");
                  generator.name = newName;
                  generator.max_output = newMax;
                  localStorage.setItem(
                    "selectedGenerator",
                    JSON.stringify(generator)
                  );
                  document.getElementById(
                    "generatorName"
                  ).textContent = `${newName} (ID: ${generator.id})`;
                  document.getElementById("maxOutput").textContent = newMax;
                  bootstrap.Modal.getInstance(
                    document.getElementById("editGeneratorModal")
                  ).hide();
                } else {
                  alert("Chyba p≈ôi aktualizaci gener√°toru.");
                }
              })
              .catch((err) => alert("Chyba: " + err));
          });

        // üóëÔ∏è Smaz√°n√≠ gener√°toru
        document
          .getElementById("deleteGenerator")
          .addEventListener("click", () => {
            if (confirm("Opravdu chcete smazat tento gener√°tor?")) {
              fetch(`http://localhost:8000/api/generators/${generatorId}`, {
                method: "DELETE",
              })
                .then((res) => res.json())
                .then((data) => {
                  if (data.status === "success") {
                    alert("Gener√°tor byl smaz√°n.");
                    localStorage.removeItem("selectedGenerator");
                    window.location.href = "generators.html";
                  } else {
                    alert("Chyba p≈ôi maz√°n√≠ gener√°toru.");
                  }
                })
                .catch((err) => alert("Chyba: " + err));
            }
          });
      });

      // ‚è¨ Ponech√°na p≈Øvodn√≠ logika ON/OFF + session + z√°tƒõ≈æ
      function loadSession() {
        fetch("http://localhost:8000/api/sessions/current", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ generator_id: generatorId }),
        })
          .then((res) => res.json())
          .then((data) => {
            const status = document.getElementById("status");
            const btnOn = document.getElementById("turnOn");
            const btnOff = document.getElementById("turnOff");
            const showLoadInput = document.getElementById("showLoadInput");

            if (data.status === "success" && data.session) {
              generatorIsOn = true;
              status.textContent = "Zapnut√Ω";
              btnOff.classList.remove("d-none");
              btnOn.classList.add("d-none");
              showLoadInput.classList.remove("d-none");

              document.getElementById("sessionStart").textContent = new Date(
                data.session.start_datetime
              ).toLocaleString();
              document.getElementById("sessionLoad").textContent =
                data.session.load_percentage + " %";
              document.getElementById("currentOutput").textContent =
                data.session.power_output + " W";
            } else {
              generatorIsOn = false;
              status.textContent = "Vypnut√Ω";
              btnOn.classList.remove("d-none");
              btnOff.classList.add("d-none");
              showLoadInput.classList.add("d-none");
              document.getElementById("sessionStart").textContent = "-";
              document.getElementById("sessionLoad").textContent = "-";
              document.getElementById("currentOutput").textContent = "-";
            }
          })
          .catch((err) => console.error("Chyba p≈ôi naƒç√≠t√°n√≠ session:", err));
      }
    </script>
  </body>
</html>
